# Ansible Configuration Management Documentation

## Overview

This document provides comprehensive documentation for all Ansible components used in the E-Commerce Platform project for server configuration and automation.

## File Structure

```
Ansible/
├── ansible.cfg                     # Ansible configuration
├── my_inventory.ini                # Dynamic inventory from Terraform
├── roles_playbook.yml             # Main playbook execution
└── roles/                         # Ansible roles for automation
    ├── Jenkins_Server_Installation/
    ├── Docker_installation/
    ├── Cloud_Watch_Agent_Installation/
    └── trivy_installation/
```

## Core Configuration Files

### ansible.cfg
**Purpose**: Main Ansible configuration file that defines behavior and settings.

**Key Configurations**:
```ini
[defaults]
inventory = my_inventory.ini
remote_user = ec2-user
private_key_file = ~/.ssh/jenkins.pem
host_key_checking = False
retry_files_enabled = False

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False
```

**Configuration Sections**:
- **[defaults]**: Basic Ansible settings
- **[inventory]**: Inventory-related configurations
- **[privilege_escalation]**: Sudo/become settings
- **[ssh_connection]**: SSH connection parameters

### my_inventory.ini
**Purpose**: Dynamic inventory file generated by Terraform containing target hosts.

**Structure**:
```ini
[jenkins_servers]
jenkins-server ansible_host=<PUBLIC_IP> ansible_user=ec2-user

[jenkins_servers:vars]
ansible_ssh_private_key_file=~/.ssh/jenkins.pem
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
```

**Generated Information**:
- Host IP addresses from Terraform outputs
- SSH connection parameters
- Host groupings for role assignment
- Instance metadata and tags

### roles_playbook.yml
**Purpose**: Main playbook that orchestrates the execution of all roles.

**Structure**:
```yaml
---
- hosts: jenkins_servers
  become: yes
  gather_facts: yes
  vars:
    ansible_ssh_pipelining: yes
  roles:
    - Jenkins_Server_Installation
    - Docker_installation
    - Cloud_Watch_Agent_Installation
    - trivy_installation
```

**Features**:
- Sequential role execution
- Fact gathering for system information
- Privilege escalation configuration
- Performance optimization settings

## Ansible Roles Documentation

### Jenkins_Server_Installation
**Purpose**: Automates Jenkins CI/CD server installation and configuration.

**Directory Structure**:
```
Jenkins_Server_Installation/
├── tasks/
│   └── main.yml              # Installation tasks
├── handlers/
│   └── main.yml              # Service handlers
├── vars/
│   └── main.yml              # Role variables
├── templates/
│   └── jenkins.service.j2    # Service templates
├── files/
│   └── plugins.txt           # Jenkins plugins list
└── README.md                 # Role documentation
```

**Installation Tasks**:
1. **System Updates**: Update package repositories
2. **Java Installation**: Install OpenJDK 11
3. **Jenkins Repository**: Add Jenkins official repository
4. **Jenkins Installation**: Install Jenkins package
5. **Plugin Installation**: Install essential plugins
6. **Service Configuration**: Configure systemd service
7. **Security Setup**: Initial security configuration
8. **User Management**: Create admin users

**Key Variables**:
```yaml
jenkins_version: "2.414.1"
jenkins_port: 8080
jenkins_home: /var/lib/jenkins
jenkins_user: jenkins
jenkins_group: jenkins
```

**Essential Plugins**:
- Pipeline plugins for CI/CD
- Git integration plugins
- Docker integration
- AWS plugins for cloud integration
- Security and authentication plugins

### Docker_installation
**Purpose**: Installs and configures Docker container runtime.

**Directory Structure**:
```
Docker_installation/
├── tasks/
│   └── main.yml              # Docker installation tasks
├── handlers/
│   └── main.yml              # Docker service handlers
├── vars/
│   └── main.yml              # Docker configuration
└── README.md                 # Role documentation
```

**Installation Process**:
1. **Prerequisites**: Install required packages
2. **Repository Setup**: Add Docker CE repository
3. **Docker Installation**: Install Docker CE
4. **Service Management**: Enable and start Docker service
5. **User Configuration**: Add users to docker group
6. **Security Configuration**: Configure Docker daemon
7. **Compose Installation**: Install Docker Compose

**Configuration Features**:
- Docker daemon optimization
- Log rotation configuration
- Registry authentication
- Security best practices
- Performance tuning

### Cloud_Watch_Agent_Installation
**Purpose**: Installs AWS CloudWatch agent for monitoring and logging.

**Directory Structure**:
```
Cloud_Watch_Agent_Installation/
├── tasks/
│   └── main.yml              # CloudWatch agent tasks
├── templates/
│   └── cloudwatch-config.json.j2  # Agent configuration
├── vars/
│   └── main.yml              # Monitoring variables
└── README.md                 # Role documentation
```

**Installation Steps**:
1. **Agent Download**: Download CloudWatch agent package
2. **Installation**: Install the agent
3. **Configuration**: Configure monitoring metrics
4. **IAM Setup**: Configure IAM permissions
5. **Service Start**: Enable and start the agent
6. **Log Configuration**: Set up log collection
7. **Custom Metrics**: Configure application metrics

**Monitored Metrics**:
- System metrics (CPU, memory, disk)
- Application logs
- Custom application metrics
- Performance counters
- Network statistics

### trivy_installation
**Purpose**: Installs Trivy vulnerability scanner for container security.

**Directory Structure**:
```
trivy_installation/
├── tasks/
│   └── main.yml              # Trivy installation tasks
├── vars/
│   └── main.yml              # Scanner configuration
└── README.md                 # Role documentation
```

**Installation Components**:
1. **Binary Download**: Download latest Trivy binary
2. **Installation**: Install to system path
3. **Database Update**: Initialize vulnerability database
4. **Configuration**: Set up scanning policies
5. **Integration**: Configure CI/CD integration
6. **Automation**: Set up scheduled scans

**Security Features**:
- Container image vulnerability scanning
- Filesystem scanning
- License detection
- Secret detection
- Policy-based scanning

## Playbook Execution

### Prerequisites
```bash
# Install Ansible
sudo yum update -y
sudo yum install -y ansible

# Or using pip
pip3 install ansible

# Verify installation
ansible --version
```

### Running Playbooks
```bash
# Run the main playbook
ansible-playbook -i my_inventory.ini roles_playbook.yml

# Run with verbose output
ansible-playbook -i my_inventory.ini roles_playbook.yml -v

# Run specific roles
ansible-playbook -i my_inventory.ini roles_playbook.yml --tags "jenkins,docker"

# Dry run (check mode)
ansible-playbook -i my_inventory.ini roles_playbook.yml --check
```

### Advanced Execution Options
```bash
# Run on specific hosts
ansible-playbook -i my_inventory.ini roles_playbook.yml --limit jenkins_servers

# Skip specific tasks
ansible-playbook -i my_inventory.ini roles_playbook.yml --skip-tags "trivy"

# Use different inventory
ansible-playbook -i custom_inventory.ini roles_playbook.yml
```

## Variable Management

### Global Variables
Located in `group_vars/` and `host_vars/` directories:

**group_vars/all.yml**:
```yaml
# Common variables for all hosts
timezone: "UTC"
ntp_servers:
  - "0.pool.ntp.org"
  - "1.pool.ntp.org"

# Security settings
ssh_port: 22
disable_root_login: true
```

### Role-Specific Variables
Each role has its own variables in `vars/main.yml`:

**Example - Jenkins variables**:
```yaml
jenkins_version: "2.414.1"
jenkins_plugins:
  - git
  - pipeline-stage-view
  - docker-workflow
  - aws-credentials
```

## Security Best Practices

### SSH Configuration
- Use SSH key-based authentication
- Disable password authentication
- Configure proper SSH timeouts
- Use SSH agent forwarding carefully

### Privilege Escalation
```yaml
# Secure sudo configuration
become: yes
become_method: sudo
become_user: root
become_flags: "-H -S"
```

### Sensitive Data Management
- Use Ansible Vault for secrets
- Encrypt sensitive variables
- Secure inventory files
- Environment-based configurations

## Error Handling and Debugging

### Common Issues and Solutions

**1. SSH Connection Failures**
```bash
# Test connectivity
ansible all -i my_inventory.ini -m ping

# Debug SSH issues
ansible all -i my_inventory.ini -m ping -vvv
```

**2. Permission Errors**
```bash
# Check sudo permissions
ansible all -i my_inventory.ini -m command -a "sudo whoami" --become

# Verify key permissions
chmod 600 ~/.ssh/jenkins.pem
```

**3. Role Execution Failures**
```bash
# Run with maximum verbosity
ansible-playbook -i my_inventory.ini roles_playbook.yml -vvv

# Check syntax
ansible-playbook --syntax-check roles_playbook.yml
```

### Debugging Commands
```bash
# List all tasks
ansible-playbook --list-tasks roles_playbook.yml

# List all tags
ansible-playbook --list-tags roles_playbook.yml

# Dry run
ansible-playbook --check roles_playbook.yml
```

## Monitoring and Maintenance

### Log Files
- **Ansible logs**: `/var/log/ansible.log`
- **Jenkins logs**: `/var/log/jenkins/jenkins.log`
- **Docker logs**: `journalctl -u docker`
- **CloudWatch agent logs**: `/opt/aws/amazon-cloudwatch-agent/logs/`

### Regular Maintenance
1. Update Ansible and modules regularly
2. Review and update role variables
3. Test playbooks in staging environment
4. Monitor system performance post-deployment
5. Update security configurations

### Performance Optimization
```yaml
# Optimize SSH connections
ansible_ssh_pipelining: yes
ansible_ssh_multiplexing: yes

# Gather facts efficiently
gather_facts: smart
fact_caching: memory
```

## Integration with CI/CD

### Jenkins Integration
The Ansible playbooks can be integrated with Jenkins for automated deployments:

```groovy
pipeline {
    agent any
    stages {
        stage('Configure Infrastructure') {
            steps {
                sh 'ansible-playbook -i inventory.ini roles_playbook.yml'
            }
        }
    }
}
```

### GitOps Integration
Ansible configurations are managed through Git for version control and automated deployment triggers.

---

For more information, see:
- [Ansible Documentation](https://docs.ansible.com/)
- [Best Practices Guide](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)
- [Project README](../README.md)
